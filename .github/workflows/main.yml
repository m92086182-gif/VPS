name: RDP Windows Server

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-2022
    timeout-minutes: 355

    steps:
      - name: Configure RDP on Windows Server
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force

      - name: Create RDP User with Custom Password
        run: |
          $password = "01276205280aaa5"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDPUser" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDPUser"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDPUser"
          Enable-LocalUser -Name "RDPUser"
          echo "RDP_CREDS=User: RDPUser | Password: $password" >> $env:GITHUB_ENV

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force
          Start-Sleep -Seconds 10

      - name: Establish Tailscale Connection
        run: |
          # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ØªØ¨Ø¯Ø£ Ø§Ù„Ø®Ø¯Ù…Ø©
          Start-Sleep -Seconds 15
          
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù…ÙØªØ§Ø­ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=win-server-$env:GITHUB_RUN_ID --accept-routes --accept-dns
          
          # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙˆÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø©
          Start-Sleep -Seconds 10
          
          # ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙØµÙ„
          Write-Host "=== Tailscale Status ==="
          & "$env:ProgramFiles\Tailscale\tailscale.exe" status
          & "$env:ProgramFiles\Tailscale\tailscale.exe" ip
          & "$env:ProgramFiles\Tailscale\tailscale.exe" netcheck
          
          # Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP
          $tsIP = $null
          for ($i = 1; $i -le 12; $i++) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              if ($tsIP) {
                  Write-Host "âœ“ ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP: $tsIP"
                  break
              }
              Write-Host "âŒ› Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© $i - ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± IP..."
              Start-Sleep -Seconds 10
          }
          
          if (-not $tsIP) {
              Write-Host "âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP Ù…Ù† Tailscale"
              Write-Host "ğŸ” ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:"
              & "$env:ProgramFiles\Tailscale\tailscale.exe" status
              exit 1
          }
          
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Verify RDP Accessibility
        run: |
          Write-Host "ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù„Ù‰: $env:TAILSCALE_IP"
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -InformationLevel Quiet
          if ($testResult) {
              Write-Host "âœ“ RDP Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§ØªØµØ§Ù„!"
          } else {
              Write-Host "âš  ÙØ´Ù„ ÙØ­Øµ RDPØŒ Ù„ÙƒÙ† Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ø³ØªÙ…Ø±Ø©..."
          }

      - name: Display Connection Info
        run: |
          Write-Host ""
          Write-Host "=" * 50
          Write-Host "RDP Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§ØªØµØ§Ù„"
          Write-Host "=" * 50
          Write-Host "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: $env:TAILSCALE_IP"
          Write-Host "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: RDPUser"
          Write-Host "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: 01276205280aaa5"
          Write-Host "=" * 50
          Write-Host ""

      - name: Maintain Session
        run: |
          $minutes = 0
          while ($minutes -lt 350) {
              Write-Host "[$(Get-Date)] Ø§Ù„Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø© - $minutes Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ù† 355"
              Start-Sleep -Seconds 60
              $minutes++
          }
          Write-Host "â° Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¯Ø© ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹"
