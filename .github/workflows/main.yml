name: Linux VPS Setup
on:
  workflow_dispatch:

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Update System and Install Essential Packages
        run: |
          sudo apt-get update
          sudo apt-get upgrade -y
          sudo apt-get install -y \
            curl \
            wget \
            git \
            build-essential \
            htop \
            net-tools \
            openssh-server \
            ufw \
            python3 \
            python3-pip \
            jq \
            iputils-ping \
            netcat-openbsd \
            telnet

      - name: Configure SSH Server
        run: |
          sudo systemctl enable ssh || true
          sudo systemctl start ssh || true
          
          # Backup original sshd_config
          sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup
          
          # Configure SSH settings
          sudo sed -i 's/#\?PasswordAuthentication .*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#\?PubkeyAuthentication .*/PubkeyAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#\?PermitRootLogin .*/PermitRootLogin yes/' /etc/ssh/sshd_config
          
          sudo systemctl restart ssh || true
          echo "âœ… SSH configured successfully"

      - name: Create Admin User with Root Privileges
        run: |
          # Generate secure random password
          PASSWORD=$(openssl rand -base64 24 | tr -d '/+=' | cut -c1-20)
          USERNAME="vpsadmin"
          
          # Remove existing user if any
          if id "$USERNAME" &>/dev/null; then
            echo "Removing existing user $USERNAME..."
            sudo userdel -r "$USERNAME" 2>/dev/null || true
            sleep 2
          fi
          
          # Create new user
          echo "Creating user $USERNAME..."
          sudo useradd -m -s /bin/bash "$USERNAME" || {
            echo "Failed to create user, trying with different approach..."
            sudo adduser --disabled-password --gecos "" "$USERNAME" || exit 1
          }
          
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo "$USERNAME"
          
          # Configure sudo without password
          echo "$USERNAME ALL=(ALL:ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/"$USERNAME"
          sudo chmod 440 /etc/sudoers.d/"$USERNAME"
          
          echo "VPS_CREDS=Username: $USERNAME | Password: $PASSWORD" >> $GITHUB_ENV
          echo "VPS_USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "VPS_PASSWORD=$PASSWORD" >> $GITHUB_ENV
          echo "âœ… User $USERNAME created successfully"

      - name: Configure Firewall
        run: |
          echo "Configuring firewall..."
          sudo ufw --force reset || true
          sudo ufw allow ssh || true
          sudo ufw allow 22/tcp || true
          echo "y" | sudo ufw enable || true
          sudo ufw status verbose || true
          echo "âœ… Firewall configured"

      - name: Install Tailscale with Enhanced Error Handling
        run: |
          set -e  # Exit on any error
          
          echo "Installing Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sh || {
            echo "âŒ Tailscale installation failed"
            exit 1
          }
          
          echo "âœ… Tailscale installed successfully"
          
          # Validate auth key
          AUTH_KEY="${{ secrets.TAILSCALE_AUTH_KEY }}"
          if [ -z "$AUTH_KEY" ]; then
            echo "âŒ ERROR: Tailscale auth key is empty"
            echo "Please set TAILSCALE_AUTH_KEY in GitHub Secrets"
            exit 1
          fi
          
          if [[ ! "$AUTH_KEY" =~ ^tskey-[a-zA-Z0-9]+ ]]; then
            echo "âŒ ERROR: Invalid Tailscale auth key format"
            echo "Key should start with 'tskey-'"
            exit 1
          fi
          
          echo "ðŸ”‘ Auth key validation passed"
          
          # Start Tailscale
          echo "Starting Tailscale..."
          sudo tailscale up --authkey="$AUTH_KEY" --hostname=gh-vps-${{ github.run_id }} --accept-routes --accept-dns || {
            echo "âŒ Tailscale startup failed"
            echo "Debug info:"
            sudo tailscale status || true
            exit 1
          }
          
          # Wait for IP assignment
          echo "Waiting for Tailscale IP..."
          TS_IP=""
          for i in {1..30}; do
            TS_IP=$(sudo tailscale ip -4 2>/dev/null || echo "")
            if [ -n "$TS_IP" ]; then
              echo "âœ… Tailscale IP assigned: $TS_IP"
              break
            fi
            echo "â³ Attempt $i/30 - Waiting for IP..."
            sleep 5
          done
          
          if [ -z "$TS_IP" ]; then
            echo "âŒ Failed to get Tailscale IP after 30 attempts"
            echo "Debug info:"
            sudo tailscale status || true
            sudo tailscale netcheck || true
            exit 1
          fi
          
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "Final Tailscale status:"
          sudo tailscale status || true

      - name: Install Development Tools
        run: |
          set -e
          
          echo "Installing Node.js..."
          curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash - && \
          sudo apt-get install -y nodejs && \
          echo "âœ… Node.js $(node --version) installed" || {
            echo "âš ï¸ Node.js installation had issues, continuing..."
          }
          
          echo "Installing Docker..."
          curl -fsSL https://get.docker.com | sh && \
          sudo usermod -aG docker $USER && \
          sudo usermod -aG docker vpsadmin && \
          sudo systemctl enable docker && \
          sudo systemctl start docker && \
          echo "âœ… Docker installed" || {
            echo "âš ï¸ Docker installation had issues, continuing..."
          }
          
          echo "Installing Docker Compose..."
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose && \
          sudo chmod +x /usr/local/bin/docker-compose && \
          echo "âœ… Docker Compose installed" || {
            echo "âš ï¸ Docker Compose installation had issues, continuing..."
          }

      - name: System Optimization
        run: |
          echo "Optimizing system settings..."
          echo "fs.inotify.max_user_watches=524288" | sudo tee -a /etc/sysctl.conf
          echo "fs.inotify.max_user_instances=512" | sudo tee -a /etc/sysctl.conf
          sudo sysctl -p || true
          sudo timedatectl set-timezone UTC || true
          echo "âœ… System optimized"

      - name: Enhanced Connectivity Test
        run: |
          echo "ðŸ” Starting connectivity tests..."
          
          # Check if Tailscale IP is set
          if [ -z "${{ env.TAILSCALE_IP }}" ]; then
            echo "âŒ TAILSCALE_IP is not set"
            exit 1
          fi
          
          echo "Testing connection to: ${{ env.TAILSCALE_IP }}"
          
          # Test basic connectivity
          echo "1. Testing basic connectivity..."
          if ping -c 2 -W 1 "${{ env.TAILSCALE_IP }}" > /dev/null 2>&1; then
            echo "âœ… Basic connectivity: SUCCESS"
          else
            echo "âš ï¸ Basic connectivity: PING FAILED (may be normal for Tailscale)"
          fi
          
          # Test SSH port with multiple methods
          echo "2. Testing SSH port (22)..."
          SSH_SUCCESS=false
          
          # Method 1: Using /dev/tcp
          if timeout 10 bash -c "echo > /dev/tcp/${{ env.TAILSCALE_IP }}/22" 2>/dev/null; then
            echo "âœ… SSH port: OPEN (bash method)"
            SSH_SUCCESS=true
          else
            echo "âš ï¸ SSH port: bash method failed"
          fi
          
          # Method 2: Using nc
          if command -v nc > /dev/null; then
            if timeout 10 nc -z -w 1 "${{ env.TAILSCALE_IP }}" 22; then
              echo "âœ… SSH port: OPEN (netcat method)"
              SSH_SUCCESS=true
            else
              echo "âš ï¸ SSH port: netcat method failed"
            fi
          fi
          
          if ! $SSH_SUCCESS; then
            echo "âŒ WARNING: SSH port may not be accessible"
            echo "This might prevent SSH connections"
          fi
          
          echo "Connectivity tests completed"

      - name: Display Final Connection Info
        run: |
          echo ""
          echo "ðŸŸ¢ ===== LINUX VPS READY ====="
          echo "ðŸŒ Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "ðŸ‘¤ Username: ${{ env.VPS_USERNAME }}"
          echo "ðŸ” Password: ${{ env.VPS_PASSWORD }}"
          echo "ðŸ”— SSH Command: ssh ${{ env.VPS_USERNAME }}@${{ env.TAILSCALE_IP }}"
          echo "â±ï¸  Timeout: 60 minutes"
          echo "==============================="
          echo ""
          echo "ðŸ’» System Status:"
          echo "SSH Service: $(systemctl is-active ssh 2>/dev/null || echo 'unknown')"
          echo "Tailscale: $(sudo tailscale status --active 2>/dev/null && echo 'Active' || echo 'Inactive')"
          echo "Docker: $(systemctl is-active docker 2>/dev/null || echo 'unknown')"
          echo ""
          echo "ðŸ”§ To connect:"
          echo "1. Ensure you're connected to Tailscale VPN"
          echo "2. Run: ssh ${{ env.VPS_USERNAME }}@${{ env.TAILSCALE_IP }}"
          echo "3. Use the password above when prompted"
          echo ""

      - name: Keep VPS Active
        run: |
          echo "ðŸš€ VPS is now active and ready!"
          echo "ðŸ’¡ Use the connection info above to SSH into your VPS"
          echo "â° This session will auto-terminate in 60 minutes"
          echo "ðŸ›‘ Cancel this workflow in GitHub Actions to stop immediately"
          
          MINUTES_REMAINING=60
          while [ $MINUTES_REMAINING -gt 0 ]; do
            echo ""
            echo "=== [$(date +'%H:%M:%S')] VPS Status ==="
            echo "IP: ${{ env.TAILSCALE_IP }}"
            echo "User: ${{ env.VPS_USERNAME }}"
            echo "Time remaining: ${MINUTES_REMAINING} minutes"
            echo "SSH: ssh ${{ env.VPS_USERNAME }}@${{ env.TAILSCALE_IP }}"
            echo "======================================"
            
            # Check critical services
            echo "Service Status:"
            echo "- SSH: $(systemctl is-active ssh 2>/dev/null || echo 'unknown')"
            echo "- Tailscale: $(sudo tailscale status --active 2>/dev/null && echo 'Active' || echo 'Check')"
            
            sleep 60
            MINUTES_REMAINING=$((MINUTES_REMAINING - 1))
          done
          
          echo "ðŸ•’ Time limit reached - VPS session ending"
