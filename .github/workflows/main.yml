name: RDP Windows Server

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-2022
    timeout-minutes: 355

    steps:
      - name: Configure RDP Settings
        run: |
          # ØªÙ…ÙƒÙŠÙ† RDP ÙˆØªØ¹Ø·ÙŠÙ„ Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø´Ø¨ÙƒØ©
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          
          # Ø¥Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø­Ù…Ø§ÙŠØ©
          netsh advfirewall firewall delete rule name="RDP" 2>&1 | Out-Null
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          
          # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª
          Restart-Service -Name TermService -Force
          Start-Service -Name SessionEnv -ErrorAction SilentlyContinue
          
          Write-Host "âœ“ ØªÙ… ØªÙƒÙˆÙŠÙ† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª RDP Ø¨Ù†Ø¬Ø§Ø­"

      - name: Disable Password Complexity and Create User
        run: |
          # ØªØ¹Ø·ÙŠÙ„ Ù…ØªØ·Ù„Ø¨Ø§Øª ØªØ¹Ù‚ÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
          try {
              secedit /export /cfg C:\secpol.cfg
              ((Get-Content C:\secpol.cfg -Raw) -replace 'PasswordComplexity = 1', 'PasswordComplexity = 0') | Set-Content C:\secpol.cfg
              ((Get-Content C:\secpol.cfg -Raw) -replace 'MinimumPasswordLength = 7', 'MinimumPasswordLength = 6') | Set-Content C:\secpol.cfg
              secedit /configure /db C:\windows\security\local.sdb /cfg C:\secpol.cfg /areas SECURITYPOLICY
              Remove-Item C:\secpol.cfg -Force -ErrorAction SilentlyContinue
              Write-Host "âœ“ ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ù…ØªØ·Ù„Ø¨Ø§Øª ØªØ¹Ù‚ÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
          } catch {
              Write-Host "âš  Ù„Ù… ÙŠØªÙ… ØªØ¹Ø·ÙŠÙ„ Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ¹Ù‚ÙŠØ¯ (Ù…Ù…ÙƒÙ† ØªÙƒÙˆÙ† Ù…Ø¹Ø·Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„)"
          }

          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
          $password = "01276205280aaa5"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ù…Ø³Ø¨Ù‚Ø§Ù‹
          $existingUser = Get-LocalUser -Name "RDPUser" -ErrorAction SilentlyContinue
          if ($existingUser) {
              Remove-LocalUser -Name "RDPUser"
              Write-Host "âœ“ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…"
          }
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
          New-LocalUser -Name "RDPUser" -Password $securePass -AccountNeverExpires -Description "RDP Access User"
          Add-LocalGroupMember -Group "Administrators" -Member "RDPUser"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDPUser"
          Enable-LocalUser -Name "RDPUser"
          
          echo "RDP_CREDS=User: RDPUser | Password: $password" >> $env:GITHUB_ENV
          Write-Host "âœ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: RDPUser"
          Write-Host "âœ“ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: $password"

      - name: Install Tailscale
        run: |
          # ØªØ«Ø¨ÙŠØª Tailscale
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          try {
              Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -TimeoutSec 30
              Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait -NoNewWindow
              Remove-Item $installerPath -Force -ErrorAction SilentlyContinue
              Write-Host "âœ“ ØªÙ… ØªØ«Ø¨ÙŠØª Tailscale Ø¨Ù†Ø¬Ø§Ø­"
          } catch {
              Write-Host "âŒ ÙØ´Ù„ ÙÙŠ ØªØ«Ø¨ÙŠØª Tailscale"
              echo "TAILSCALE_STATUS=FAILED" >> $env:GITHUB_ENV
          }
          
          Start-Sleep -Seconds 10

      - name: Setup Tailscale Connection
        run: |
          # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©
          Start-Sleep -Seconds 15
          
          # ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Tailscale Ù…Ø«Ø¨Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
          if (Test-Path "$env:ProgramFiles\Tailscale\tailscale.exe") {
              Write-Host "âœ“ Tailscale Ù…Ø«Ø¨Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­"
              
              # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
              & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=win-server-$env:GITHUB_RUN_ID --accept-routes --accept-dns
              
              # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP
              $tsIP = $null
              for ($i = 1; $i -le 15; $i++) {
                  $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
                  if ($tsIP -and $tsIP -notlike "*error*") {
                      Write-Host "âœ“ ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† Tailscale: $tsIP"
                      echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
                      break
                  }
                  Write-Host "âŒ› ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¹Ù†ÙˆØ§Ù† IP... Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© $i"
                  Start-Sleep -Seconds 5
              }
              
              if (-not $tsIP) {
                  Write-Host "âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† Tailscale"
                  echo "TAILSCALE_IP=FAILED" >> $env:GITHUB_ENV
              }
          } else {
              Write-Host "âŒ Tailscale ØºÙŠØ± Ù…Ø«Ø¨Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­"
              echo "TAILSCALE_IP=NOT_INSTALLED" >> $env:GITHUB_ENV
          }

      - name: Verify RDP Setup
        run: |
          # ÙØ­Øµ Ø­Ø§Ù„Ø© RDP
          $rdpEnabled = (Get-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections").fDenyTSConnections
          $userExists = Get-LocalUser -Name "RDPUser" -ErrorAction SilentlyContinue
          
          Write-Host "=== ÙØ­Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ==="
          Write-Host "RDP Ù…ÙØ¹Ù„: $(if ($rdpEnabled -eq 0) { 'Ù†Ø¹Ù…' } else { 'Ù„Ø§' })"
          Write-Host "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯: $(if ($userExists) { 'Ù†Ø¹Ù…' } else { 'Ù„Ø§' })"
          Write-Host "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: 01276205280aaa5"
          
          if ($env:TAILSCALE_IP -and $env:TAILSCALE_IP -notin @('FAILED', 'NOT_INSTALLED')) {
              Write-Host "Ø¹Ù†ÙˆØ§Ù† Tailscale: $env:TAILSCALE_IP"
              
              # ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„
              $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -InformationLevel Quiet -WarningAction SilentlyContinue
              Write-Host "Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø´Ø¨ÙƒØ© RDP: $(if ($testResult) { 'Ù†Ø§Ø¬Ø­' } else { 'ÙØ§Ø´Ù„' })"
          } else {
              Write-Host "âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Tailscale Ù†Ø´Ø·"
          }
          Write-Host "===================="

      - name: Display Connection Information
        run: |
          Write-Host ""
          Write-Host "=" * 60
          Write-Host "ğŸ¯ RDP WINDOWS SERVER 2022 - Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§ØªØµØ§Ù„"
          Write-Host "=" * 60
          Write-Host "ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: RDPUser"
          Write-Host "ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: 01276205280aaa5"
          
          if ($env:TAILSCALE_IP -and $env:TAILSCALE_IP -notin @('FAILED', 'NOT_INSTALLED')) {
              Write-Host "ğŸŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: $env:TAILSCALE_IP"
              Write-Host "ğŸ“ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©: Ø§Ø³ØªØ®Ø¯Ù… Tailscale VPN Ù„Ù„Ø§ØªØµØ§Ù„"
          } else {
              Write-Host "ğŸŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: Ø§Ø³ØªØ®Ø¯Ù… Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù€ Runner Ù…Ø¨Ø§Ø´Ø±Ø©"
              Write-Host "ğŸ“ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©: Ø§ØªØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø± (Ù‚Ø¯ ÙŠØ­ØªØ§Ø¬ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø´Ø¨ÙƒØ©)"
          }
          
          Write-Host "â° Ø§Ù„Ù…Ø¯Ø©: 6 Ø³Ø§Ø¹Ø§Øª ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰"
          Write-Host "âš¡ Ø§Ù„Ø­Ø§Ù„Ø©: Ù†Ø´Ø· ÙˆØ¬Ø§Ù‡Ø²"
          Write-Host "=" * 60
          Write-Host ""

      - name: Maintain Active Session
        run: |
          Write-Host "ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© - Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¹Ø¯Ù… Ø¥ØºÙ„Ø§Ù‚ Ù‡Ø°Ø§ Ø§Ù„ØªÙ†ÙÙŠØ°"
          Write-Host "â³ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: 5 Ø³Ø§Ø¹Ø§Øª Ùˆ55 Ø¯Ù‚ÙŠÙ‚Ø©"
          
          $startTime = Get-Date
          $checkInterval = 60 # Ø«Ø§Ù†ÙŠØ©
          
          for ($minute = 1; $minute -le 355; $minute++) {
              $elapsed = (Get-Date) - $startTime
              $remaining = New-TimeSpan -Minutes (355 - $minute)
              
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] â° $minute/355 Ø¯Ù‚ÙŠÙ‚Ø© - Ù…ØªØ¨Ù‚ÙŠ: $($remaining.ToString('hh\:mm'))"
              
              # ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
              if ($minute % 5 -eq 0) {
                  $rdpService = Get-Service -Name TermService -ErrorAction SilentlyContinue
                  $tsService = Get-Service -Name Tailscale -ErrorAction SilentlyContinue
                  
                  Write-Host "   ğŸ” ÙØ­Øµ Ø§Ù„Ø®Ø¯Ù…Ø§Øª - RDP: $($rdpService.Status) | Tailscale: $(if ($tsService) { $tsService.Status } else { 'Not Found' })"
              }
              
              Start-Sleep -Seconds $checkInterval
          }
          
          Write-Host "ğŸ›‘ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¯Ø© - Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ù„Ø³Ø©"
